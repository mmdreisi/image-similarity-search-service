<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ø¬Ø³ØªØ¬ÙˆÚ¯Ø± Ø¨Ø§ ØªØµÙˆÛŒØ±</title>
    <link rel="stylesheet" href="assets/font.css" />
    <style>
      body {
        font-family: "Vazirmatn", sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        direction: rtl;
      }
      .container {
        max-width: 600px;
        width: 100%;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        text-align: center;
      }
      h1 {
        color: #333;
        margin-bottom: 20px;
      }
      .upload-area {
        border: 2px dashed #87fd81;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .upload-area p {
        margin: 10px 0;
        color: #666;
      }
      .btn {
        background-color: #8ed557;
        color: #fff;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
      }
      .btn:hover {
        background-color: #7fc945;
      }
      .supported-formats {
        color: #666;
        font-size: 0.9em;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Ø¬Ø³ØªØ¬ÙˆÚ¯Ø± Ø¨Ø§ ØªØµÙˆÛŒØ±</h1>
      <p>Ø¨Ù‡ Ø¬Ø§ÛŒ Ù†ÙˆØ´ØªÙ†ØŒ Ø¹Ú©Ø³ Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†</p>
      <div class="upload-area">
        <input
          type="file"
          id="imageInput"
          accept="image/jpeg,image/png,image/gif,image/webp"
          style="display: none"
        />
        <button
          class="btn"
          onclick="document.getElementById('imageInput').click()"
        >
          Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØµÙˆÛŒØ±
        </button>
        <p>ÛŒØ§</p>
        <p>ØªØµÙˆÛŒØ± Ø±Ø§ Ø¯Ø±ÙˆÙ† Ø§ÛŒÙ† Ú©Ø§Ø¯Ø± Ø¨ÛŒÙ†Ø¯Ø§Ø²</p>
      </div>
      <p class="supported-formats">
        ÙØ±Ù…Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø´Ø¯Ù‡: JPGØŒ PNGØŒ GIFØŒ WEBP
      </p>
    </div>

    <script>
      const uploadArea = document.querySelector(".upload-area");
      const imageInput = document.getElementById("imageInput");

      // Drag and Drop
      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.style.backgroundColor = "#e8f4e8";
      });

      uploadArea.addEventListener("dragleave", () => {
        uploadArea.style.backgroundColor = "transparent";
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.style.backgroundColor = "transparent";
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith("image/")) {
          uploadImage(file);
        } else {
          alert("Ù„Ø·ÙØ§Ù‹ ÛŒÚ© ÙØ§ÛŒÙ„ ØªØµÙˆÛŒØ±ÛŒ Ù…Ø¹ØªØ¨Ø± (JPG, PNG, GIF, WEBP) Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.");
        }
      });

      // File input change
      imageInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          uploadImage(file);
        }
      });

      async function uploadImage(file) {
        const formData = new FormData();
        formData.append("image", file);

        try {
          console.log("Sending request to /api/search_image with file:", file.name);

          // ğŸ”¹ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬Ùˆ (Ù…Ù†ØªØ¸Ø± Ù¾Ø§Ø³Ø®)
          const response = await fetch("http://localhost:8000/api/search_image", {
            method: "POST",
            body: formData,
          });

          if (response.ok) {
            const data = await response.json();
            console.log("Response data:", data);

            // ğŸ”¹ Ø§ÙˆÙ„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø°Ø®ÛŒØ±Ù‡ Ø´ÙˆÙ†Ø¯
            sessionStorage.setItem("searchResults", JSON.stringify(data))

            console.log("Saved to sessionStorage:", sessionStorage.getItem("searchResults"));


            // ğŸ”¹ Ø¨Ø¹Ø¯ Ø§Ø±Ø³Ø§Ù„ ØªØµÙˆÛŒØ± Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø±Ø§ Ø¢ØºØ§Ø² Ú©Ù† ÙˆÙ„ÛŒ Ù…Ù†ØªØ¸Ø±Ø´ Ù†Ø¨Ø§Ø´
            sendToSaveEndpoint(file);

            // ğŸ”¹ Ø­Ø§Ù„Ø§ Ø¨Ø§ ÛŒÚ© ØªØ§Ø®ÛŒØ± Ú©ÙˆÚ†Ú© Ø¨Ø±Ùˆ Ø¨Ù‡ ØµÙØ­Ù‡ Ù†ØªØ§ÛŒØ¬
            setTimeout(() => {
              window.location.href = "results.html";
            }, 500);
          } else {
            const text = await response.text();
            console.error("Server response:", text);
            alert(`Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ ØªØµÙˆÛŒØ± (${response.status})`);
          }
        } catch (error) {
          console.error("Error uploading image:", error);
          alert(`Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±: ${error.message}`);
        }
      }


      // ğŸ”¸ ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ ØªØµÙˆÛŒØ± Ø¨Ù‡ /api/save_image Ø¨Ø¯ÙˆÙ† ØªØ£Ø®ÛŒØ±
      function sendToSaveEndpoint(file) {
        const saveForm = new FormData();
        saveForm.append("image", file);
        fetch("http://localhost:8000/api/save_image", {
          method: "POST",
          body: saveForm,
        })
          .then((res) => res.json())
          .then((data) => console.log("Save queued:", data))
          .catch((err) => console.error("Save error:", err));
      }
    </script>

  </body>
</html>
